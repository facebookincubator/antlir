load("//antlir/bzl:oss_shim.bzl", "rust_binary", "rust_library", "rust_unittest", "third_party")

rust_library(
    name = "btrfs_send_stream_upgrade_lib",
    srcs = ["src/lib.rs"] + glob([
        "src/mp/*.rs",
    ]) + glob([
        "src/mp/sync/*.rs",
    ]) + glob([
        "src/mp/threads/*.rs",
    ]) + glob([
        "src/send_elements/*.rs",
    ]) + glob([
        "src/upgrade/*.rs",
    ]),
    deps = third_party.libraries(
        [
            "anyhow",
            "crc32c-hw",
            "lazy_static",
            "maplit",
            "num",
            "num-derive",
            "num-traits",
            "slog",
            "slog-term",
            "structopt",
            "thiserror",
            "zstd",
        ],
        platform = "rust",
    ),
)

rust_binary(
    name = "btrfs_send_stream_upgrade",
    srcs = ["src/main.rs"],
    visibility = [
        "//antlir/...",
        "//tupperware/image/imgtool/...",
    ],
    deps = [":btrfs_send_stream_upgrade_lib"] +
           third_party.libraries(
               [
                   "anyhow",
                   "structopt",
               ],
               platform = "rust",
           ),
)

rust_unittest(
    name = "test-ordered-element-queue",
    srcs = ["tests/test_ordered_element_queue.rs"],
    deps = [":btrfs_send_stream_upgrade_lib"] +
           third_party.libraries(
               [
                   "anyhow",
                   "rand",
               ],
               platform = "rust",
           ),
)

rust_unittest(
    name = "test-read-once-buffer-cache",
    srcs = ["tests/test_read_once_buffer_cache.rs"],
    deps = [":btrfs_send_stream_upgrade_lib"] +
           third_party.libraries(
               [
                   "anyhow",
                   "rand",
                   "structopt",
                   "tempfile",
               ],
               platform = "rust",
           ),
)

rust_unittest(
    name = "test-unordered-element-queue",
    srcs = ["tests/test_unordered_element_queue.rs"],
    deps = [":btrfs_send_stream_upgrade_lib"] +
           third_party.libraries(
               [
                   "anyhow",
                   "rand",
               ],
               platform = "rust",
           ),
)
