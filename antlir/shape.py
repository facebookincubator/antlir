#!/usr/bin/env python3
# Copyright (c) Facebook, Inc. and its affiliates.
#
# This source code is licensed under the MIT license found in the
# LICENSE file in the root directory of this source tree.

# Python runtime component of shape.bzl. This file is not meant to be used
# directly, instead it contains supporting implementations for bzl/shape.bzl.
# See that file for motivations and usage documentation.

import importlib.resources
from typing import Type, TypeVar

import pydantic
from pydantic import BaseModel


S = TypeVar("S")


class ShapeMeta(pydantic.main.ModelMetaclass):
    def __new__(metacls, name, bases, dct):  # noqa: B902
        cls = super().__new__(metacls, name, bases, dct)
        cls.__name__ = repr(cls)
        cls.__qualname__ = repr(cls)
        return cls

    def __repr__(cls):  # noqa: B902
        """
        Human-readable class __repr__, that hides the ugly autogenerated
        shape class names.
        """
        fields = ", ".join(
            f"{key}={f._type_display()}" for key, f in cls.__fields__.items()
        )
        return f"shape({fields})"


class Shape(BaseModel, metaclass=ShapeMeta):
    class Config:
        allow_mutation = False

    @classmethod
    def read_resource(cls: Type[S], package: str, name: str) -> S:
        with importlib.resources.open_text(package, name) as r:
            return cls.parse_raw(r.read())

    def __repr__(self):
        """
        Human-readable instance __repr__, that hides the ugly autogenerated
        shape class names.
        """
        # print only the set fields in the defined order
        fields = ", ".join(
            f"{key}={repr(getattr(self, key))}" for key in self.__fields__
        )
        return f"shape({fields})"
