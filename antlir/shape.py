#!/usr/bin/env python3
# Copyright (c) Facebook, Inc. and its affiliates.
#
# This source code is licensed under the MIT license found in the
# LICENSE file in the root directory of this source tree.

# Python runtime component of shape.bzl. This file is not meant to be used
# directly, instead it contains supporting implementations for bzl/shape.bzl.
# See that file for motivations and usage documentation.

import importlib.resources
from typing import Type, TypeVar

import pydantic


S = TypeVar("S")


class ShapeMeta(pydantic.main.ModelMetaclass):
    def __new__(metacls, name, bases, dct):  # noqa: B902
        cls = super().__new__(metacls, name, bases, dct)
        # Only apply shape meta hacks to generated classes, not user-written
        # subclasses
        cls.__GENERATED_SHAPE__ = dct.get("__GENERATED_SHAPE__", False)
        if cls.__GENERATED_SHAPE__:
            cls.__name__ = repr(cls)
            cls.__qualname__ = repr(cls)
            # promote nested shape types to this class based on the field name
            # so they can be referred to without the generated name
            for key, f in cls.__fields__.items():
                if getattr(f.type_, "__GENERATED_SHAPE__", False):
                    setattr(cls, key, f.type_)

        return cls

    def __repr__(cls):  # noqa: B902
        """
        Human-readable class __repr__, that hides the ugly autogenerated
        shape class names.
        """
        fields = ", ".join(
            f"{key}={f._type_display()}" for key, f in cls.__fields__.items()
        )
        clsname = "shape"
        if not cls.__GENERATED_SHAPE__:
            clsname = cls.__name__
        return f"{clsname}({fields})"


class Shape(pydantic.BaseModel, metaclass=ShapeMeta):
    class Config:
        allow_mutation = False

    @classmethod
    def read_resource(cls: Type[S], package: str, name: str) -> S:
        with importlib.resources.open_text(package, name) as r:
            return cls.parse_raw(r.read())

    def __repr__(self):
        """
        Human-readable instance __repr__, that hides the ugly autogenerated
        shape class names.
        """
        if not type(self).__GENERATED_SHAPE__:
            return super().__repr__()
        # print only the set fields in the defined order
        fields = ", ".join(
            f"{key}={repr(getattr(self, key))}" for key in self.__fields__
        )
        return f"shape({fields})"
