load("//antlir/bzl:build_defs.bzl", "alias")
load("//antlir/distro/deps:defs.bzl", "select_triple")
load("//antlir/distro/deps:rpm_library.bzl", "rpm_library")
load("//antlir/distro/deps:sysroot.bzl", "export_from_sysroot")

oncall("antlir")

[
    rpm_library(
        name = name,
        lib = select_triple("/usr/lib/clang/19/lib/{{triple}}-gnu/lib{}.a".format(name)),
        link_whole = True,
        rpm = "compiler-rt-19.1.7",
        # These fail for some reason because of how we turn static libs into shared libs.
        tests = False,
    )
    for name in (
        "clang_rt.asan",
        "clang_rt.asan_cxx",
        "clang_rt.dfsan",
        "clang_rt.hwasan",
        "clang_rt.hwasan_cxx",
        "clang_rt.msan",
        "clang_rt.msan_cxx",
        "clang_rt.tsan",
        "clang_rt.tsan_cxx",
        "clang_rt.ubsan_standalone",
        "clang_rt.ubsan_standalone_cxx",
    )
]

rpm_library(
    name = "LLVM",
    header_glob = [
        ("/usr/include", "llvm/**/*"),
        ("/usr/include", "llvm-c/**/*"),
    ],
    lib = "libLLVM.so.19.1",
    rpm = [
        "llvm-libs-19.1.7",
        "llvm-devel-19.1.7",
    ],
)

# Normally we link all these statically; however in Centos9 the llvm static libs
# somehow pick up symbols from gcc-toolset-13 (). So we don't have to move to
# that toolset before fbcode does, let's just alias everything to the shared lib.
[
    alias(
        name = lib,
        actual = ":LLVM",
        labels = ["antlir-distro-dep"],
        visibility = ["PUBLIC"],
    )
    for lib in (
        "LLVMAArch64AsmParser",
        "LLVMAArch64CodeGen",
        "LLVMAArch64Desc",
        "LLVMAArch64Disassembler",
        "LLVMAArch64Info",
        "LLVMAArch64Utils",
        "LLVMAggressiveInstCombine",
        "LLVMAnalysis",
        "LLVMAsmParser",
        "LLVMAsmPrinter",
        "LLVMBPFAsmParser",
        "LLVMBPFCodeGen",
        "LLVMBPFDesc",
        "LLVMBPFDisassembler",
        "LLVMBPFInfo",
        "LLVMBinaryFormat",
        "LLVMBitReader",
        "LLVMBitWriter",
        "LLVMBitstreamReader",
        "LLVMCFGuard",
        "LLVMCFIVerify",
        "LLVMCodeGen",
        "LLVMCodeGenData",
        "LLVMCodeGenTypes",
        "LLVMCore",
        "LLVMCoroutines",
        "LLVMCoverage",
        "LLVMDWARFLinker",
        "LLVMDWARFLinkerClassic",
        "LLVMDWARFLinkerParallel",
        "LLVMDWP",
        "LLVMDebugInfoBTF",
        "LLVMDebugInfoCodeView",
        "LLVMDebugInfoDWARF",
        "LLVMDebugInfoGSYM",
        "LLVMDebugInfoLogicalView",
        "LLVMDebugInfoMSF",
        "LLVMDebugInfoPDB",
        "LLVMDebuginfod",
        "LLVMDemangle",
        "LLVMDiff",
        "LLVMDlltoolDriver",
        "LLVMExecutionEngine",
        "LLVMExegesis",
        "LLVMExegesisAArch64",
        "LLVMExegesisX86",
        "LLVMExtensions",
        "LLVMFileCheck",
        "LLVMFrontendDriver",
        "LLVMFrontendHLSL",
        "LLVMFrontendOffloading",
        "LLVMFrontendOpenACC",
        "LLVMFrontendOpenMP",
        "LLVMFuzzMutate",
        "LLVMFuzzerCLI",
        "LLVMGlobalISel",
        "LLVMHipStdPar",
        "LLVMIRPrinter",
        "LLVMIRReader",
        "LLVMInstCombine",
        "LLVMInstrumentation",
        "LLVMInterfaceStub",
        "LLVMInterpreter",
        "LLVMJITLink",
        "LLVMLTO",
        "LLVMLibDriver",
        "LLVMLineEditor",
        "LLVMLinker",
        "LLVMMC",
        "LLVMMCA",
        "LLVMMCDisassembler",
        "LLVMMCJIT",
        "LLVMMCParser",
        "LLVMMIRParser",
        "LLVMNVPTXCodeGen",
        "LLVMNVPTXDesc",
        "LLVMNVPTXInfo",
        "LLVMObjCARCOpts",
        "LLVMObjCopy",
        "LLVMObject",
        "LLVMObjectYAML",
        "LLVMOptDriver",
        "LLVMOption",
        "LLVMOrcDebugging",
        "LLVMOrcJIT",
        "LLVMOrcShared",
        "LLVMOrcTargetProcess",
        "LLVMPasses",
        "LLVMPerfJITEvents",
        "LLVMProfileData",
        "LLVMRISCVAsmParser",
        "LLVMRISCVCodeGen",
        "LLVMRISCVDesc",
        "LLVMRISCVDisassembler",
        "LLVMRISCVInfo",
        "LLVMRISCVTargetMCA",
        "LLVMRemarks",
        "LLVMRuntimeDyld",
        "LLVMSandboxIR",
        "LLVMScalarOpts",
        "LLVMSelectionDAG",
        "LLVMSupport",
        "LLVMSymbolize",
        "LLVMTableGen",
        "LLVMTableGenBasic",
        "LLVMTableGenCommon",
        "LLVMTarget",
        "LLVMTargetParser",
        "LLVMTextAPI",
        "LLVMTextAPIBinaryReader",
        "LLVMTransformUtils",
        "LLVMVectorize",
        "LLVMWebAssemblyAsmParser",
        "LLVMWebAssemblyCodeGen",
        "LLVMWebAssemblyDesc",
        "LLVMWebAssemblyDisassembler",
        "LLVMWebAssemblyInfo",
        "LLVMWebAssemblyUtils",
        "LLVMWindowsDriver",
        "LLVMWindowsManifest",
        "LLVMX86AsmParser",
        "LLVMX86CodeGen",
        "LLVMX86Desc",
        "LLVMX86Disassembler",
        "LLVMX86Info",
        "LLVMX86TargetMCA",
        "LLVMXRay",
        "LLVMipo",
    )
]

export_from_sysroot(
    name = "resource-dir",
    dir = True,
    path = "/usr/lib/clang/19",
)

export_from_sysroot(
    name = "include",
    dir = True,
    path = "/usr/lib/clang/19/include",
)
