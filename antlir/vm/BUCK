# @noautodeps

load("//antlir/bzl:image.bzl", "image")
load("//antlir/bzl:layer_resource.bzl", "layer_resource")
load("//antlir/bzl:oss_shim.bzl", "buck_genrule", "export_file", "kernel_get", "python_binary", "python_library", "third_party")
load("//antlir/bzl/image/feature:defs.bzl", "feature")
load("//antlir/bzl/linux/boot/systemd:defs.bzl", "boot")
load("//antlir/vm/bzl:defs.bzl", "vm")

roms = [
    "kvmvapic.bin",
    "linuxboot_dma.bin",
    "vgabios-stdvga.bin",
    "efi-virtio.rom",
]

buck_genrule(
    name = "roms",
    out = ".",
    cmd = " && ".join([
        "cp $(location {}) $OUT/".format(
            third_party.library(
                "qemu",
                "share/qemu/{}".format(rom),
            ),
        )
        for rom in roms
    ]),
    visibility = ["PUBLIC"],
)

buck_genrule(
    name = "efi-code",
    out = "out",
    cmd = "cp $(location {}) $OUT".format(
        third_party.library(
            "qemu",
            "share/qemu/edk2-x86_64-code.fd",
        ),
    ),
    visibility = ["PUBLIC"],
)

python_library(
    name = "common",
    srcs = [
        "common.py",
    ],
)

python_library(
    name = "guest-ssh",
    srcs = [
        "guest_ssh.py",
    ],
    resources = {
        "//antlir/linux/vm/ssh:privkey": "privkey",
    },
    deps = [
        "//antlir:common",
        "//antlir/nspawn_in_subvol:common",
    ],
)

python_library(
    name = "vm",
    srcs = [
        "vm.py",
    ],
    resources = {
        ":router-advertiser": "router-advertiser",
    },
    deps = [
        ":common",
        ":guest-ssh",
        ":share",
        ":tap",
        ":tpm",
        "//antlir:common",
        "//antlir:config",
        "//antlir:find_built_subvol",
        "//antlir:shape",
        "//antlir:testlib_layer_resource",
        "//antlir:unshare",
        "//antlir/compiler/items:mount",
        "//antlir/vm/bzl:vm.shape-python",
    ],
)

python_binary(
    name = "run",
    srcs = [
        "run.py",
    ],
    main_module = "antlir.vm.run",
    visibility = ["PUBLIC"],
    deps = [
        ":vm",
    ],
)

python_library(
    name = "tap",
    srcs = ["tap.py"],
    deps = [
        "//antlir:unshare",
    ],
)

python_library(
    name = "tpm",
    srcs = ["tpm.py"],
    deps = [
        ":common",
        "//antlir:fs_utils",
        "//antlir:unshare",
    ],
)

python_binary(
    name = "router-advertiser",
    srcs = ["router_advertiser.py"],
    main_module = "antlir.vm.router_advertiser",
    resources = {layer_resource(":radvd"): "radvd-layer"},
    deps = [
        "//antlir:testlib_layer_resource",
    ],
)

image.layer(
    name = "radvd",
    parent_layer = vm.artifacts.rootfs.layer,
    features = [
        image.rpms_install(["radvd"]),
        feature.remove("/etc/radvd.conf"),
        feature.install("radvd.conf", "/etc/radvd.conf"),
    ],
)

# defines the `Share` dataclass for vm
python_library(
    name = "share",
    srcs = ["share.py"],
    deps = ["//antlir:fs_utils"],
)

export_file(
    name = "mount-generator",
    src = "mount-generator",
    visibility = [
        "//antlir/linux/vm/...",
        "//antlir/vm/tests/...",
        "//images/...",
        "//metalos/...",
    ],
)

python_binary(
    name = "wrap-in-vm-test-exec",
    srcs = [
        "wrap_in_vm_test_exec.py",
    ],
    main_module = "antlir.vm.wrap_in_vm_test_exec",
    visibility = ["PUBLIC"],
    deps = [
        "//antlir:common",
        "//antlir:fs_utils",
    ],
)

python_binary(
    name = "vmtest",
    srcs = [
        "vmtest.py",
    ],
    main_module = "antlir.vm.vmtest",
    visibility = ["PUBLIC"],
    deps = [
        ":common",
        ":share",
        ":vm",
        "//antlir:artifacts_dir",
        "//antlir:common",
        "//antlir:fs_utils",
    ],
)

vm.run(
    name = "default",
    vm_opts = vm.types.opts.new(
        kernel = kernel_get.default,
        disk = vm.artifacts.rootfs.disk,
    ),
)

vm.run(
    name = "default-initrd-debug",
    vm_opts = vm.types.opts.new(
        kernel = kernel_get.default,
        disk = vm.artifacts.rootfs.disk,
        append = [
            "initrd.break",
        ],
    ),
    args = [
        "--append-console",
        "--shell=console",
    ],
)

# Build a bootable EFI package using systemd-boot
boot.build(
    # The target name of the boot package
    # Use this in a gpt.image as a partition
    name = "systemd-boot",
    # The LABEL assigned to the rootfs
    label = "/",
    # List of kernels to install
    # Note: this will also install the initrd
    kernels = [
        kernel_get.default,
    ],
)
