load("//antlir/antlir2/bzl/feature:defs.bzl", "feature")
load("//antlir/antlir2/bzl/image:defs.bzl", "image")
load("//antlir/antlir2/testing:image_test.bzl", "image_sh_test")
load("//antlir/bzl:build_defs.bzl", "rust_binary")

oncall("twimage")

image.layer(
    name = "base",
    features = [
        # dependencies of the test
        feature.rpms_install(rpms = [
            "bash",
            "util-linux",
        ]),
    ],
    flavor = "//antlir/antlir2/test_images:test-image-flavor",
)

rust_binary(
    name = "binary_1",
    srcs = ["main.rs"],
    unittests = False,
)

rust_binary(
    name = "binary_2",
    srcs = ["main.rs"],
    unittests = False,
)

image.layer(
    name = "extract-buck",
    features = [
        feature.ensure_dirs_exist(dirs = "/usr/bin"),
        feature.extract_buck_binary(
            src = ":binary_1",
            dst = "/usr/bin/test-binary-extracted",
        ),
        feature.install(
            src = ":binary_2",
            dst = "/usr/bin/test-binary-installed",
            mode = "a+rx",
        ),
    ],
    parent_layer = ":base",
)

image_sh_test(
    name = "extract-buck-test",
    layer = ":extract-buck",
    test = "test-extract-buck.sh",
)

image.layer(
    name = "binaries-clone-src",
    features = [
        feature.rpms_install(rpms = ["systemd"]),
        feature.ensure_file_symlink(
            link = "/usr/bin/systemctl.link",
            target = "/usr/bin/systemctl",
        ),
    ],
    flavor = "//antlir/antlir2/test_images:test-image-flavor",
)

image.layer(
    name = "binary-clone",
    features = [
        feature.ensure_dirs_exist(dirs = "/usr/bin"),
        feature.clone(
            dst_path = "/usr/bin/systemctl",
            src_layer = ":binaries-clone-src",
            src_path = "/usr/bin/systemctl",
        ),
    ],
    parent_layer = ":base",
)

image_sh_test(
    name = "binary-clone-fails",
    layer = ":binary-clone",
    test = "test-binary-clone-fails.sh",
)

image.layer(
    name = "extract-layer",
    features = [
        feature.ensure_dirs_exist(dirs = "/usr/bin"),
        feature.extract_from_layer(
            binaries = [
                "/usr/bin/systemctl",
            ],
            layer = ":binaries-clone-src",
        ),
        # TODO(T153572212): in the future this should be an error and require
        # the use of feature.extract_buck_binary
        feature.extract_from_layer(
            binaries = [
                "/usr/bin/test-binary-installed",
            ],
            layer = ":extract-buck",
        ),
    ],
    parent_layer = ":base",
)

image_sh_test(
    name = "extract-layer-test",
    layer = ":extract-layer",
    test = "test-extract-layer.sh",
)

image.layer(
    name = "extract-symlink-layer",
    features = [
        feature.ensure_dirs_exist(dirs = "/usr/bin"),
        feature.extract_from_layer(
            binaries = [
                "/usr/bin/systemctl.link",
            ],
            layer = ":binaries-clone-src",
        ),
    ],
    parent_layer = ":base",
)

image_sh_test(
    name = "extract-symlink-layer-test",
    layer = ":extract-symlink-layer",
    test = "test-extract-symlink-layer.sh",
)
