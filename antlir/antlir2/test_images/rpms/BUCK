load("//antlir/antlir2/bzl/feature:defs.bzl", "feature")
load("//antlir/antlir2/bzl/image:defs.bzl", "image")
load("//antlir/antlir2/testing:image_test.bzl", "image_sh_test")
load("//antlir/bzl:build_defs.bzl", "alias")
load("//antlir/rpm/dnf2buck:repo.bzl", "repo_set")

repo_set(
    name = "test-repo-set",
    repo_sets = select({
        "ovr_config//cpu:arm64": [
            "//bot_generated/antlir/rpm/fast_snapshot/by_flavor:centos9-aarch64",
        ],
        "ovr_config//cpu:x86_64": [
            "//bot_generated/antlir/rpm/fast_snapshot/by_flavor:centos9",
        ],
    }),
    repos = select({
        "ovr_config//cpu:arm64": [
            "//antlir/rpm/dnf2buck/demo/aarch64:test-repo",
        ],
        "ovr_config//cpu:x86_64": [
            "//antlir/rpm/dnf2buck/demo/x86_64:test-repo",
        ],
    }),
)

image.layer(
    name = "simple",
    available_rpm_repos = ":test-repo-set",
    features = [
        feature.rpms_install(
            rpms = [
                "rpm-test-cheese",  # the thing I am checking
                # dependencies of the test
                "bash",
                "rpm",
                "dracut-squash",  # random package that depends on another 'dracut'
            ],
        ),
    ],
    flavor = "//antlir/antlir2/test_images:test-image-flavor",
)

image_sh_test(
    name = "simple-test",
    layer = ":simple",
    test = "test.sh",
)

image.layer(
    name = "remove",
    available_rpm_repos = ":test-repo-set",
    features = [
        feature.rpms_remove_if_exists(rpms = [
            "rpm-test-cheese",
            "dracut",
        ]),
    ],
    parent_layer = ":simple",
)

image_sh_test(
    name = "remove-test",
    layer = ":remove",
    test = "test-remove.sh",
)

# select() basically doesn't work anywhere in the antlir2 api for now, so
# instead we can use an alias to select the right rpm to install which is
# sufficient for this use case of doing the same thing, just with a different
# underlying file
alias(
    name = "rpm-test-cheese-2-1.rpm",
    actual = select({
        "ovr_config//cpu:arm64": "//antlir/rpm/dnf2buck/demo/aarch64:rpm-test-cheese-2-1.aarch64.rpm",
        "ovr_config//cpu:x86_64": "//antlir/rpm/dnf2buck/demo/x86_64:rpm-test-cheese-2-1.x86_64.rpm",
    }),
)

image.layer(
    name = "local-rpm-file",
    features = [
        feature.rpms_install(rpms = [":rpm-test-cheese-2-1.rpm"]),
    ],
    flavor = "//antlir/antlir2/test_images:test-image-flavor",
    parent_layer = ":simple",
)

image_sh_test(
    name = "local-rpm-file-test",
    layer = ":local-rpm-file",
    test = "test-local-rpm-file.sh",
)
