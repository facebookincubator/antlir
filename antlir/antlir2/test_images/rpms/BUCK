load("//antlir/antlir2:antlir2_layer.bzl", "antlir2_layer")
load("//antlir/antlir2/feature:defs.bzl", "feature")
load("//antlir/antlir2/testing:image_test.bzl", "image_sh_test")
load("//antlir/rpm/dnf2buck:repo.bzl", "repo_set")

repo_set(
    name = "test-repo-set",
    repo_sets = select({
        "ovr_config//cpu:arm64": [
            "//bot_generated/antlir/rpm/fast_snapshot/by_flavor:centos9-aarch64",
        ],
        "ovr_config//cpu:x86_64": [
            "//bot_generated/antlir/rpm/fast_snapshot/by_flavor:centos9",
        ],
    }),
    repos = select({
        "ovr_config//cpu:arm64": [
            "//antlir/rpm/dnf2buck/demo/aarch64:test-repo",
        ],
        "ovr_config//cpu:x86_64": [
            "//antlir/rpm/dnf2buck/demo/x86_64:test-repo",
        ],
    }),
)

antlir2_layer(
    name = "simple",
    available_rpm_repos = ":test-repo-set",
    features = [
        feature.rpms_install(
            rpms = [
                "rpm-test-cheese",  # the thing I am checking
                # dependencies of the test
                "bash",
                "rpm",
                "dracut-squash",  # random package that depends on another 'dracut'
            ],
        ),
    ],
    flavor = "//antlir/antlir2/test_images:test-image-flavor",
)

image_sh_test(
    name = "simple-test",
    layer = ":simple",
    test = "test.sh",
)

antlir2_layer(
    name = "remove",
    available_rpm_repos = ":test-repo-set",
    features = [
        feature.rpms_remove_if_exists(rpms = [
            "rpm-test-cheese",
            "dracut",
        ]),
    ],
    parent_layer = ":simple",
)

image_sh_test(
    name = "remove-test",
    layer = ":remove",
    test = "test-remove.sh",
)
