load("//antlir/antlir2/bzl:toolchain.bzl", "antlir2_toolchain")
load("//antlir/antlir2/bzl/feature:defs.bzl", "feature")
load("//antlir/antlir2/bzl/image:defs.bzl", "image")
load("//antlir/antlir2/bzl/package:defs.bzl", "package")

image.layer(
    name = "build-appliance",
    features = [
        feature.rpms_install(rpms = [
            "btrfs-progs",
            "cpio",
            "dnf",
            "dosfstools",
            "iproute",
            "mtools",
            "python3-dnf-plugin-cow",
            "rpm-build",
            "socat",
            "squashfs-tools",
            "strace",
            "systemd-container",
            "zstd",
            # @oss-disable
            # @oss-disable
        ]),
        # Ensure that we don't end up with upstream dnf repos that might
        # interfere with the snapshot
        feature.remove(path = "/etc/yum.repos.d"),
        feature.remove(path = "/etc/dnf/dnf.conf"),
        feature.ensure_dirs_exist(dirs = "/antlir"),
    ],
    flavor = "//antlir/antlir2/facebook/flavor:centos9",
)

package.sendstream_v2(
    name = "build-appliance.sendstream.v2",
    layer = ":build-appliance",
)

antlir2_toolchain(
    name = "toolchain",
    # yo dawg, i heard you liked antlir2...
    antlir2 = "//antlir/antlir2/antlir2:antlir2",
    visibility = ["PUBLIC"],
)
