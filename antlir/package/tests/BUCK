load("//antlir/bzl:image_python_unittest.bzl", "image_python_unittest")
load("//antlir/bzl:layer_resource.bzl", "layer_resource")
load("//antlir/bzl/image/package:btrfs.bzl", "btrfs")
load("//antlir/compiler:defs.bzl", "TEST_IMAGE_PREFIX")

oncall("twimage")

btrfs.new(
    name = "single-subvol",
    opts = btrfs.opts.new(
        subvols = {
            "/create-ops": btrfs.opts.subvol.new(
                layer = "//antlir/compiler/test_images:create_ops",
            ),
        },
    ),
)

btrfs.new(
    name = "single-subvol-fixed-size",
    opts = btrfs.opts.new(
        subvols = {
            "/volume": btrfs.opts.subvol.new(
                layer = "//antlir/compiler/test_images:create_ops",
            ),
        },
    ),
)

btrfs.new(
    name = "single-subvol-additional-size",
    opts = btrfs.opts.new(
        free_mb = 1024,
        subvols = {
            "/volume": btrfs.opts.subvol.new(
                layer = "//antlir/compiler/test_images:create_ops",
            ),
        },
    ),
)

btrfs.new(
    name = "single-subvol-seed-device",
    opts = btrfs.opts.new(
        seed_device = True,
        subvols = {
            "/create-ops": btrfs.opts.subvol.new(
                layer = "//antlir/compiler/test_images:create_ops",
            ),
        },
    ),
)

btrfs.new(
    name = "multiple-subvol",
    opts = btrfs.opts.new(
        subvols = {
            "/create-ops-1": btrfs.opts.subvol.new(
                layer = "//antlir/compiler/test_images:create_ops",
            ),
            "/create-ops-2": btrfs.opts.subvol.new(
                layer = "//antlir/compiler/test_images:create_ops",
            ),
        },
    ),
)

btrfs.new(
    name = "multiple-subvol-fixed-size",
    opts = btrfs.opts.new(
        subvols = {
            "/create-ops-1": btrfs.opts.subvol.new(
                layer = "//antlir/compiler/test_images:create_ops",
            ),
            "/create-ops-2": btrfs.opts.subvol.new(
                layer = "//antlir/compiler/test_images:create_ops",
            ),
        },
    ),
)

btrfs.new(
    name = "nested-subvol-fixed-size",
    opts = btrfs.opts.new(
        subvols = {
            "/create-ops": btrfs.opts.subvol.new(
                layer = "//antlir/compiler/test_images:create_ops",
            ),
            "/create-ops/child-ops": btrfs.opts.subvol.new(
                layer = "//antlir/compiler/test_images:create_ops",
            ),
        },
    ),
)

image_python_unittest(
    name = "test-package-btrfs",
    srcs = ["test_package_btrfs.py"],
    container_opts = {
        "internal_only_allow_mknod": True,
        "internal_only_bind_artifacts_dir_rw": True,
        "internal_only_bind_repo_ro": True,
    },
    layer = TEST_IMAGE_PREFIX + "build_appliance_testing",
    needed_coverage = [(100, "//antlir/package:btrfs-library")],
    resources = {
        layer_resource(TEST_IMAGE_PREFIX + "create_ops-original.sendstream"): "create_ops-original.sendstream",
        layer_resource(TEST_IMAGE_PREFIX + "create_ops"): "create_ops",
        layer_resource(TEST_IMAGE_PREFIX + "build_appliance_testing"): "build-appliance-testing",
        layer_resource(TEST_IMAGE_PREFIX + "create_ops_btrfs"): "create_ops_btrfs",
        layer_resource(TEST_IMAGE_PREFIX + "create_ops_free_mb_btrfs"): "create_ops_free_mb_btrfs",
    },
    run_as_user = "root",
    deps = [
        "//antlir:find_built_subvol",
        "//antlir:fs_utils",
        "//antlir:subvol_utils",
        "//antlir:testlib_image_package_testbase",
        "//antlir:testlib_layer_resource",
        "//antlir:unshare",
        "//antlir/package:btrfs-library",
        # Include the test packages defined here so they are built
        # when the test is built.
        ":multiple-subvol",
        ":multiple-subvol-fixed-size",
        ":single-subvol",
        ":single-subvol-seed-device",
        ":single-subvol-fixed-size",
        ":nested-subvol-fixed-size",
    ],
)
