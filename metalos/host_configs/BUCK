# @noautodeps

load("@bazel_skylib//lib:paths.bzl", "paths")
load("//antlir/bzl:image.bzl", "image")
load("//antlir/bzl:oss_shim.bzl", "buck_filegroup", "third_party", "thrift_library")
load("//antlir/bzl/image/feature:defs.bzl", "feature")
load("//metalos:defs.bzl", "rust_binary")

# @oss-disable: facebook = True 
# @oss-enable facebook = False

thrift_library(
    name = "host",
    languages = ["rust"] + [
        "cpp2",
        "py3",
    ] if facebook else [],
    # @oss-disable: py3_namespace = "metalos.host_configs", 
    rust_crate_name = "host",
    rust_deps = ["//metalos/metalos_macros:metalos_macros"] + third_party.libraries(
        [
            "derive_builder",
            "paste",
            "starlark",
            "starlark_derive",
        ],
        platform = "rust",
    ),
    rust_features = [
        # @oss-disable: "facebook", 
    ],
    rust_include_srcs = ["host_thrift.rs"],
    rust_unittests = True,
    thrift_rust_options = "serde",
    thrift_srcs = {"host.thrift": None},
    visibility = [
        "PUBLIC",
    ],
    deps = [
        ":runtime-config",
    ] + [
        "//metalos/host_configs/facebook:host-facebook",
    ] if facebook else [],
)

buck_filegroup(
    name = "all_starklark_files",
    srcs = glob(["**/*.star"]),
)

# This binary is useful to manually check what a host config generator would
# produce for a given host input, without having to boot a physical server or go
# through vmtest
# Usage:
#   construct a host json input (by hand or download it from the proxy service in facebook/service)
#   buck run //metalos/host_configs:evaluator -- host.json path/to/generator.star
rust_binary(
    name = "evaluator",
    srcs = glob(["evaluator/**/*.rs"]),
    visibility = [],
    deps = [
        "anyhow",
        "serde_json",
        "slog",
        "slog_glog_fmt",
        "structopt",
        "//metalos/host_configs/evalctx:evalctx",
    ],
)

feature.new(
    name = "generators",
    features = [
        image.ensure_subdirs_exist("/usr/lib/metalos", "generators"),
    ] + [
        feature.install(
            src,
            "/usr/lib/metalos/generators/{}".format(paths.basename(src)),
        )
        for src in glob(["generators/*.star"])
    ],
    visibility = ["//metalos/..."],
)

thrift_library(
    name = "package-manifest",
    languages = ["rust"] + [
        "cpp2",
        "py3",
    ] if facebook else [],
    # @oss-disable: py3_namespace = "metalos.host_configs", 
    thrift_rust_options = "serde",
    thrift_srcs = {"package_manifest.thrift": None},
    visibility = [
        "PUBLIC",
    ],
)

thrift_library(
    name = "runtime-config",
    languages = ["rust"] + [
        "cpp2",
        "py3",
    ] if facebook else [],
    # @oss-disable: py3_namespace = "metalos.host_configs", 
    thrift_rust_options = "serde",
    thrift_srcs = {"runtime_config.thrift": None},
    visibility = [
        "PUBLIC",
    ],
    deps = [
        ":package-manifest",
    ],
)
