name: Tests
on: [push, pull_request, workflow_call]

defaults:
  run:
    shell: bash

jobs:
  test:
    runs-on:
      # this runner comes with 150GB of disk space
      labels: 4-core-ubuntu
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: true

      - uses: facebook/install-dotslash@latest
      - uses: dtolnay/rust-toolchain@stable
        id: rust-toolchain
        with:
          targets: x86_64-unknown-linux-gnu,aarch64-unknown-linux-gnu

      - name: BTRFS-ify antlir2-out
        run: |
          mkdir antlir2-out
          truncate -s 100G ${{ runner.temp }}/image.btrfs
          mkfs.btrfs ${{ runner.temp }}/image.btrfs
          sudo mount ${{ runner.temp }}/image.btrfs antlir2-out
          sudo chown -R $(id -u):$(id -g) antlir2-out
      - name: Install system deps
        run: |
          sudo apt install \
            cpio jq libcap-dev systemd-container

      - name: Install nativelink
        uses: baptiste0928/cargo-install@v3
        with:
          crate: nativelink
          git: https://github.com/TraceMachina/nativelink
          tag: v0.5.3

      - name: Restore buck2 cache
        id: cache-restore
        uses: actions/cache/restore@v4
        with:
          path: |
            /tmp/nativelink
          key: nativelink-${{ steps.rust-toolchain.outputs.cachekey }}
          restore-keys: |
            nativelink-

      - uses: JarvusInnovations/background-action@v1
        name: Start NativeLink
        with:
          run: |
            nativelink ci/nativelink.json &
          wait-on: |
            tcp:localhost:50051

      - name: Setup CI buckconfig
        run: |
          cp ci/buckconfig .buckconfig.local

      - name: Test target graph
        run: |
          ./buck2 bxl //ci:test_target_graph.bxl:test_target_graph

      - name: Find tests
        run: |
          ./buck2 bxl //ci:find_tests.bxl:find_tests -- \
            --disable //antlir/antlir2/antlir2_btrfs/... \
            --disable //antlir/antlir2/antlir2_cas_dir:antlir2_cas_dir-image-test \
            --disable //antlir/antlir2/antlir2_overlayfs/... \
            --disable //antlir/antlir2/antlir2_vm:antlir2_vm-unittest \
            --disable //antlir/antlir2/genrule_in_image/... \
            --disable //antlir/antlir2/image_command_alias/... \
            --disable //antlir/antlir2/sendstream_parser:sendstream_parser-unittest \
            --disable //antlir/antlir2/test_images/cfg/os/... \
            --disable //antlir/antlir2/test_images/cfg/target_arch/... \
            --disable //antlir/antlir2/test_images/package/erofs/... \
            --disable //antlir/antlir2/test_images/package/tar/... \
            --disable //antlir/antlir2/testing/tests:booted-image-test-that-should-fail \
            --disable //antlir/antlir2/testing/tests:test-sh-booted-requires-units \
            --disable //antlir/bzl/shape2/... \
            --disable //antlir/bzl/tests/shapes/... \
            --disable //antlir/rust:gen-modules-bzl-unittest \
            --disable //third-party/antlir/tests:hello_world.default.test \
            --disable //third-party/antlir/tests:hello_world.patched.test \
            | tee ${{ runner.temp }}/tests.txt

      - name: Build tests
        run: |
          ./buck2 build --keep-going @${{ runner.temp }}/tests.txt

      - name: Upload buck2 cache
        uses: actions/cache/restore@v4
        with:
          path: |
            /tmp/nativelink
          key: ${{ steps.cache-restore.outputs.cache-primary-key }}

      - name: Run tests
        run: |
          ./buck2 test --keep-going @${{ runner.temp }}/tests.txt
