on: [push, pull_request]

jobs:
  test:
    runs-on: ubuntu-20.04

    steps:
      - uses: actions/checkout@v2

      - name: Checkout submodules
        run: git submodule update --init

      - name: Install system dependencies
        run: sudo apt-get install -y systemd-container libcap-ng-dev

      # createrepo_c is not packaged for Ubuntu 20.04. Until it is or until we
      # can use a hosted runner that is based on CentOS (or Fedora), compile
      # createrepo_c so that unit tests are able to use it to make ephemeral
      # rpm repositories.
      - name: Build createrepo_c
        run: |
          sudo apt-get update
          sudo apt-get install libssl-dev liblzma-dev libxml2-dev libmagic-dev libcurl4-openssl-dev libbz2-dev librpm-dev
          curl -L https://github.com/rpm-software-management/createrepo_c/archive/0.16.2.tar.gz | gunzip | tar -x
          cd createrepo_c-0.16.2
          mkdir build && cd build
          cmake .. -DENABLE_DRPM=0 -DWITH_ZCHUNK=0 -DWITH_LIBMODULEMD=0 -DENABLE_PYTHON=0
          make -j$(nproc)
          mv src/createrepo_c $GITHUB_WORKSPACE/tools/
        working-directory: /tmp

      - name: Set up $PATH
        run: echo $(pwd)/tools > $GITHUB_PATH

      # antlir is primarily developed on CentOS, which has a 'nobody:nobody'
      # user and group. GitHub actions is running on ubuntu which uses
      # 'nobody:nogroup', so create a 'nobody' group to use
      - name: Set up nobody group
        run: sudo groupadd nobody; sudo usermod -aG nobody nobody

      - uses: actions/setup-python@v2
        with:
          python-version: '~3.8'

      # .buckconfig explicitly references /usr/bin/python3
      # Ensure that /usr/bin/python3 points to the python3.8 install setup by
      # the above step
      - name: Symlink Python3.8
        run: sudo ln -sf $(which python3.8) /usr/bin/python3

      - name: Fetch buck
        run: buck --version

      - name: Fetch remote artifacts
        run: buck fetch //...

      # This is not quite a test, but exercises a lot of antlir and is expected
      # to pass, unlike the unit tests below, not all of which have been fixed
      # to support the OSS build (mainly due to missing 'yum')
      - name: Build base image
        run: buck build //images/base:fedora32

      - name: Build all targets
        run: buck build //...

      - name: Run tests
        run: buck test //... --exclude disabled
