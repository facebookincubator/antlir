load("//antlir/bzl:oss_shim.bzl", "buck_genrule", "http_file")
load("//antlir/bzl:vm.bzl", "vm")
load("//antlir/vm:kernel.bzl", "build_kernel_artifacts")
load("//antlir/vm/initrd:defs.bzl", "initrd")

http_file(
    name = "5.3.7-301.fc31.x86_64-core.rpm",
    sha256 = "f0509e333636e5c34726c8a2b8260bf88fe0a35b95cae6dda62191fee1be4c6a",
    urls = [
        "http://mirrors.kernel.org/fedora/releases/31/Everything/x86_64/os/Packages/k/kernel-core-5.3.7-301.fc31.x86_64.rpm",
    ],
    visibility = [],
)

http_file(
    name = "5.3.6-300.fc31.x86_64-headers.rpm",
    sha256 = "d31acb5e7a91e55c0cea895d2c18da63d29b8e6452ed78b597c5e29c9f83f8fa",
    urls = [
        "http://mirrors.kernel.org/fedora/releases/31/Everything/x86_64/os/Packages/k/kernel-headers-5.3.6-300.fc31.x86_64.rpm",
    ],
)

http_file(
    name = "5.3.7-301.fc31.x86_64-devel.rpm",
    sha256 = "733aa63b13d26af5bb0596cbeec342a6c9c199bb8348948613e84e976b5d0aa2",
    urls = [
        "http://mirrors.kernel.org/fedora/releases/31/Everything/x86_64/os/Packages/k/kernel-devel-5.3.7-301.fc31.x86_64.rpm",
    ],
)

buck_genrule(
    name = "5.3.7-301.fc31.x86_64-rpm-exploded",
    out = ".",
    cmd = """
        cd $OUT
        rpm2cpio $(location :5.3.7-301.fc31.x86_64-core.rpm) | cpio -idm
        # Removing build and source since they are symlinks that do not exist on the host
        rm -r lib/modules/5.3.7-301.fc31.x86_64/build lib/modules/5.3.7-301.fc31.x86_64/source
    """,
)

buck_genrule(
    name = "5.3.7-301.fc31.x86_64-vmlinuz",
    out = "vmlinuz-5.3.7-301.fc31.x86_64",
    cmd = "cp --reflink=auto $(location :5.3.7-301.fc31.x86_64-rpm-exploded)/lib/modules/5.3.7-301.fc31.x86_64/vmlinuz $OUT",
)

# Build kernel artifacts and get back a shape instance
kernel = build_kernel_artifacts(
    devel_rpm = ":5.3.7-301.fc31.x86_64-devel.rpm",
    include_vmlinux = False,
    rpm_exploded = ":5.3.7-301.fc31.x86_64-rpm-exploded",
    uname = "5.3.7-301.fc31.x86_64",
)

initrd(kernel = kernel)

vm.run(
    name = "5.3.7-301.fc31.x86_64",
    vm_opts = vm.opts(
        kernel = kernel,
    ),
)
