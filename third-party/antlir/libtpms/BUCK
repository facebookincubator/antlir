# Copyright (c) Meta Platforms, Inc. and affiliates.
#
# This source code is licensed under the MIT license found in the
# LICENSE file in the root directory of this source tree.

load("//antlir/bzl:image.bzl", "image")
load("//antlir/bzl:third_party.bzl", "third_party")

BASE_FEATURES = [
    image.rpms_install([
        # build deps
        "gcc",
        "autoconf",
        "autoconf-archive",
        "libtool",
        "make",
        "sed",
        "net-tools",
        "tpm-tools",
        "expect",
        "socat",
        # static deps
        "glibc-static",
        "glib2-static",
        "pcre-static",
    ]),
]

third_party.native_build(
    base_features = BASE_FEATURES,
    dependencies = [
        third_party.library("openssl"),
    ],
    script = third_party.script(
        prepare = """
            export MAKEFLAGS=-j

            export CFLAGS="-I${STAGE}/include"
            export LDFLAGS="-L${STAGE}/lib"
            export PKG_CONFIG_PATH="${STAGE}/lib/pkgconfig"

            # need to fix a global symbol otherwise it collides
            # later on due to static linkage
            sed -i 's/char state_directory/static char state_directory/' ./src/tpm12/tpm_nvfile.c

            ./autogen.sh --with-openssl --prefix="${STAGE}" --with-tpm2 --disable-shared
        """,
        build = "make",
        install = "make install",
    ),
)
