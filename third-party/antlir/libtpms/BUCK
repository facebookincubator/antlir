# Copyright (c) Meta Platforms, Inc. and affiliates.
#
# This source code is licensed under the MIT license found in the
# LICENSE file in the root directory of this source tree.

load("//antlir/bzl:third_party.bzl", "third_party")
load("//antlir/bzl/image/feature:defs.bzl", "feature")

oncall("antlir")

third_party.build(
    name = "libtpms",
    src = third_party.source("libtpms"),
    features = [
        feature.rpms_install([
            # build deps
            "gcc",
            "autoconf",
            "autoconf-archive",
            "libtool",
            "make",
            "sed",
            "net-tools",
            "tpm-tools",
            "expect",
            "socat",
            # static deps
            "glibc-static",
            "glib2-static",
            "pcre-static",
        ]),
    ],
    script = third_party.script(
        build = "make",
        install = "make install",
        prepare = """
export CFLAGS="-fPIC -I/third-party-build/deps/libcrypto/include"
export LDFLAGS="-L/third-party-build/deps/libcrypto/lib"

# need to fix a global symbol otherwise it collides
# later on due to static linkage
sed -i 's/char state_directory/static char state_directory/' ./src/tpm12/tpm_nvfile.c

./autogen.sh --prefix="${OUTPUT}" --with-openssl --with-tpm2 --disable-shared
        """,
    ),
    visibility = ["//antlir/third-party/..."],
    deps = [
        third_party.library("libcrypto"),
    ],
)
