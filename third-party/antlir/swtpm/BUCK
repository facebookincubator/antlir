# Copyright (c) Meta Platforms, Inc. and affiliates.
#
# This source code is licensed under the MIT license found in the
# LICENSE file in the root directory of this source tree.

load("//antlir/bzl:oss_shim.bzl", "buck_genrule")
load("//antlir/bzl:third_party.bzl", "third_party")

BASE_FEATURES = [
    feature.rpms_install([
        # build deps
        "gcc",
        "autoconf",
        "autoconf-archive",
        "libtool",
        "make",
        "findutils",
        "net-tools",
        "tpm-tools",
        "expect",
        "socat",
        "python38",
        # static deps
        "glibc-static",
        "glib2-static",
        "pcre-static",
        "libtasn1-devel",  # required but seemingly unused (ok with shared here)
    ]),
]

third_party.native_build(
    base_features = BASE_FEATURES,
    dependencies = [
        third_party.library("openssl"),
        third_party.library(
            "libffi",
            lib_path = "lib64",
        ),
        third_party.library(
            "json-glib",
            lib_path = "lib64",
        ),
        third_party.library("libtpms"),
    ],
    script = third_party.script(
        prepare = """
            export MAKEFLAGS=-j

            export CFLAGS="-I${STAGE}/include"
            export LDFLAGS="-L${STAGE}/lib -L${STAGE}/lib64"
            export PKG_CONFIG_PATH="${STAGE}/lib/pkgconfig:${STAGE}/lib64/pkgconfig"

            LIBS="-lcrypto -ldl -lpthread" \
            ./autogen.sh --prefix="${STAGE}" --with-openssl --without-gnutls --without-selinux --without-cuse --without-seccomp
        """,
        build = """
            # swtpm doesnt support static linkage by itself, so convince it
            make CFLAGS="${CFLAGS}" LDFLAGS="${LDFLAGS} -all-static" LIBS="-ldl -lpthread -lpcre -lffi"
        """,
        install = """
            make install

            # swtpm creates a root only folder to keep CA files, and it's not copyable
            # from outside the container, since we don't need it, delete
            rm -rf "${STAGE}/var"
        """,
    ),
)

buck_genrule(
    name = "bin",
    out = "swtpm",
    bash = "cp $(location :swtpm)/bin/swtpm $OUT",
)
