# Copyright (c) Meta Platforms, Inc. and affiliates.
#
# This source code is licensed under the MIT license found in the
# LICENSE file in the root directory of this source tree.

load("//antlir/bzl:image.bzl", "image")
load("//antlir/bzl:third_party.bzl", "third_party")

BASE_FEATURES = [
    image.rpms_install([
        # build deps
        "clang",
        "perl",
    ]),
]

third_party.native_build(
    base_features = BASE_FEATURES,
    script = third_party.script(
        prepare = """
            export MAKEFLAGS=-j
            ./Configure no-shared --prefix="${STAGE}" -fno-omit-frame-pointer linux-x86_64-clang
        """,
        build = "make",
        install = """
            make install

            # some symlinks here trip an image.install later on so remove them
            # because they're not being used anyway (just keep include, lib)
            for n in bin share ssl; do
                    rm -rf "${STAGE}/$n"
            done
        """,
    ),
)
